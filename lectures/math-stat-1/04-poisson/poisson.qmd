---
title: "Mathematical Statistics"
subtitle: "The Poisson Probability Distribution"
author:
  - name: "Samir Orujov, PhD"
    affiliations:
      - name: "ADA University, School of Business"
      - name: "Information Communication Technologies Agency, Statistics Unit"
date: today
format:
  revealjs:
    theme: default
    logo: ADA.png
    transition: slide
    slide-number: c/t
    chalkboard: true
    controls: true
    navigation-mode: linear
    width: 1280
    height: 720
    footer: "Mathematical Statistics - The Poisson Probability Distribution"
    incremental: false
    highlight-style: tango
    code-fold: true
    menu: true
    progress: true
    history: true
    quiz:
      checkKey: 'c'
      resetKey: 'r'
      shuffleKey: 's'
      allowNumberKeys: true
      disableOnCheck: false
      disableReset: false
      shuffleOptions: true
      defaultCorrect: "‚úÖ Correct! Well done."
      defaultIncorrect: "‚ùå Not quite. Try again or check the explanation."
      includeScore: true
revealjs-plugins:
  - quiz
---

## üéØ Learning Objectives

::: {style="font-size: 35px"}
::: {.learning-objectives}
By the end of this lecture, you will be able to:

- Understand the conditions under which the Poisson distribution applies, using finance and economics examples

- Derive the Poisson distribution from the binomial, and apply the formula to compute probabilities

- Interpret the parameters and properties of Poisson random variables in financial modeling contexts

- Calculate mean and variance of Poisson-distributed variables

- Model and solve investment, risk, and event frequency problems using the Poisson distribution
:::
:::

## üìã Overview 

::: {style="font-size:50px"}
::: {.callout-note}
## <span>üìö</span> Topics Covered Today
::: {.incremental}
- **Poisson Probability Distribution** ‚Äì Definition and derivation
- **Poisson Experiments** ‚Äì Identifying conditions in finance and economics
- **Probability Calculations** ‚Äì Using formula and statistical tables
- **Mean and Variance** ‚Äì Expected value and risk measures
- **Applications** ‚Äì Credit risk, insurance, financial event modeling
- **Poisson Approximation to Binomial** ‚Äì When and why
:::
:::
:::

---

## üìñ Definition: Poisson Experiment {.larger}

::: {.callout-note}
## <span>üìù</span> Definition 1: Poisson Experiment

A **Poisson experiment** meets the following requirements:

::: {.incremental}

1. **Random events occur independently** in a fixed interval of time/space (e.g., defaults per month, trades per hour)

2. **Average event rate ($\lambda$) is constant** over intervals (e.g., 3 defaults/month on average)

3. **Probability of more than one event in a tiny subinterval is negligible**

4. **Interval split into $n$ subintervals:**
   - $P$(one event in subinterval) = $p$
   - $P$(no event in subinterval) = $1-p$
   - $P$(>1 event in subinterval) = $0$
:::
:::


---

## üßÆ Deriving the Poisson Distribution (Part 1)

::: {style="font-size:30px";}

::: {.callout-note}
## <span>üéØ</span> Motivation: From Binomial to Poisson

The Poisson distribution models **rare events** in finance and economics:
- Credit defaults in large portfolios
- Insurance claims arriving over time
- High-frequency trading events
- Customer arrivals at service centers

These occur when $n$ is **very large** and $p$ is **very small**.
:::



::: {.callout-important .fragment style="top-margin:2em"}
## <span>üîë</span> Key Insight

When $n \to \infty$ and $p \to 0$ such that $np = \lambda$ (constant), the binomial distribution converges to the Poisson distribution.

**Intuition**: Many trials with rare success ‚Üí counting rare events in an interval
:::

:::

---

## üßÆ Deriving the Poisson Distribution (Part 2) {.smaller}

**Starting Point**: Binomial probability mass function

$$
p(y) = \binom{n}{y} p^y (1-p)^{n-y}
$$

**Substitution**: Let $p = \frac{\lambda}{n}$ where $\lambda = np$ is constant

$$
p(y) = \binom{n}{y} \left(\frac{\lambda}{n}\right)^y \left(1-\frac{\lambda}{n}\right)^{n-y}
$$

. . .

**Expand the binomial coefficient**:

$$
p(y) = \frac{n!}{y!(n-y)!} \cdot \frac{\lambda^y}{n^y} \cdot \left(1-\frac{\lambda}{n}\right)^{n-y}
$$

---

## üßÆ Deriving the Poisson Distribution (Part 3) {.smaller}

**Rewrite the factorial**:

$$
p(y) = \frac{n(n-1)(n-2)\cdots(n-y+1)}{y!} \cdot \frac{\lambda^y}{n^y} \cdot \left(1-\frac{\lambda}{n}\right)^{n-y}
$$

. . .

**Rearrange**:

$$
p(y) = \frac{\lambda^y}{y!} \cdot \frac{n(n-1)(n-2)\cdots(n-y+1)}{n^y} \cdot \left(1-\frac{\lambda}{n}\right)^{n} \cdot \left(1-\frac{\lambda}{n}\right)^{-y}
$$

. . .

**Factor out $n^y$ from numerator**:

$$
\frac{n(n-1)\cdots(n-y+1)}{n^y} = \left(1\right)\left(1-\frac{1}{n}\right)\left(1-\frac{2}{n}\right)\cdots\left(1-\frac{y-1}{n}\right)
$$

---

## üßÆ Deriving the Poisson Distribution (Part 4) {.smaller}

**Take the limit as** $n \to \infty$:

$$
p(y) = \frac{\lambda^y}{y!} \cdot \lim_{n\to\infty}\left[\left(1-\frac{1}{n}\right)\cdots\left(1-\frac{y-1}{n}\right)\right] \cdot \lim_{n\to\infty}\left(1-\frac{\lambda}{n}\right)^{n} \cdot \lim_{n\to\infty}\left(1-\frac{\lambda}{n}\right)^{-y}
$$

. . .

**Evaluate each limit**:

1. $\lim_{n\to\infty}\left(1-\frac{k}{n}\right) = 1$ for fixed $k$ ‚Üí **First limit = 1**

2. $\lim_{n\to\infty}\left(1-\frac{\lambda}{n}\right)^{n} = e^{-\lambda}$ (fundamental limit) ‚Üí **Second limit = $e^{-\lambda}$**

3. $\lim_{n\to\infty}\left(1-\frac{\lambda}{n}\right)^{-y} = 1$ for fixed $y$ ‚Üí **Third limit = 1**

---

## üßÆ Deriving the Poisson Distribution (Part 5) {.smaller}

**Combine all the limits**:

$$
p(y) = \frac{\lambda^y}{y!} \cdot 1 \cdot e^{-\lambda} \cdot 1
$$

. . .

::: {.callout-tip}
## <span>‚úÖ</span> Final Result: The Poisson Probability Distribution

$$
\boxed{p(y) = \frac{\lambda^y e^{-\lambda}}{y!}, \quad y = 0, 1, 2, \ldots, \quad \lambda > 0}
$$

Where:
- $y$ = number of events (defaults, claims, arrivals, etc.)
- $\lambda$ = average rate (expected number of events per interval)
- $e \approx 2.71828$ (Euler's number)
:::

. . .

::: {.callout-important}
## <span>üí°</span> Financial Interpretation

This formula gives the probability of observing exactly $y$ rare events when the average rate is $\lambda$ per time/space interval.
:::

---


## üìà Poisson Probability Distribution {.larger}

::: {.callout-note}
## <span>üìù</span> Definition 2: Poisson Probability Distribution
A random variable $Y$ is Poisson-distributed if:
$$
p(y) = \frac{\lambda^y}{y!} e^{-\lambda}, \quad y = 0, 1, 2, ...
$$

Where $\lambda$ is the average rate (mean number of events per interval).
:::


### **Key Properties**
- Probabilities are always $0 \leq p(y) \leq 1$
- Sum of all probabilities $= 1$ (series for $e^{\lambda}$)

---

## üìå Example 1: Credit Risk Event Modeling {.large}

A loan portfolio averages **2 defaults per month ($\lambda = 2$)**. What is the probability that there are **exactly 3 defaults** next month?

**Solution**:
$$
p(3) = \frac{2^3}{3!} e^{-2} = \frac{8}{6} e^{-2} = 1.333 \times 0.135 = 0.180
$$

---

## üìå Example 2: Insurance Claims {.large}

An insurer receives **5 claims per day** on average ($\lambda = 5$). What is the probability of receiving **at least 2 claims** tomorrow?

**Solution**:
$$
P(Y \geq 2) = 1 - p(0) - p(1)
$$

$$
p(0) = \frac{5^0}{0!} e^{-5} = e^{-5} = 0.0067
$$

$$
p(1) = \frac{5^1}{1!} e^{-5} = 5 \times 0.0067 = 0.0337
$$

$$
P(Y \geq 2) = 1 - 0.0067 - 0.0337 = 0.9596
$$

---

## ‚úÖ Proving the Poisson is a Valid Distribution

::: {.callout-note}
## <span>üìù</span> What We Need to Prove

For the Poisson distribution to be valid, we must verify two properties:

1. **Non-negativity**: $0 \le p(y) \le 1$ for all $y$
2. **Total probability**: $\sum_{y=0}^{\infty} p(y) = 1$
:::

. . .

::: {.callout-tip}
## <span>‚úì</span> Property 1: Non-negativity

Since $\lambda > 0$, $y! > 0$, and $e^{-\lambda} > 0$ for all values:

$$
p(y) = \frac{\lambda^y e^{-\lambda}}{y!} > 0 \quad \text{for all } y = 0, 1, 2, \ldots
$$

Also, $p(y) = 0$ for negative $y$ (since we're counting events). ‚úì
:::

---

## ‚úÖ Proving Total Probability Equals 1 {.smaller}

::: {.callout-important}
## <span>üìù</span> Property 2: Sum of All Probabilities

We need to show that:
$$
\sum_{y=0}^{\infty} p(y) = \sum_{y=0}^{\infty} \frac{\lambda^y e^{-\lambda}}{y!} = 1
$$
:::

. . .

::: {.columns}
::: {.column width="50%"}
**Step 1**: Factor out the constant $e^{-\lambda}$

$$
\sum_{y=0}^{\infty} \frac{\lambda^y e^{-\lambda}}{y!} = e^{-\lambda} \sum_{y=0}^{\infty} \frac{\lambda^y}{y!}
$$

:::

::: {.column width="50%" .fragment}
**Step 2**: Recognize the Taylor series expansion of $e^{\lambda}$

::: {.callout-tip}
## <span>üîë</span> Key Mathematical Fact: Taylor Series for $e^x$

$$
e^x = \sum_{k=0}^{\infty} \frac{x^k}{k!} = 1 + x + \frac{x^2}{2!} + \frac{x^3}{3!} + \cdots
$$

For $x = \lambda$:
$$
e^{\lambda} = \sum_{y=0}^{\infty} \frac{\lambda^y}{y!}
$$
:::
:::
:::

---

## ‚úÖ Final Result {.smaller}

**Step 3**: Substitute the Taylor series

$$
\sum_{y=0}^{\infty} \frac{\lambda^y e^{-\lambda}}{y!} = e^{-\lambda} \cdot \sum_{y=0}^{\infty} \frac{\lambda^y}{y!} = e^{-\lambda} \cdot e^{\lambda}
$$

. . .

**Step 4**: Simplify using exponent rules

$$
e^{-\lambda} \cdot e^{\lambda} = e^{-\lambda + \lambda} = e^{0} = 1
$$

. . .

::: {.columns}
::: {.column width="50%"}
::: {.callout-note}
## <span>‚úÖ</span> Conclusion

$$
\boxed{\sum_{y=0}^{\infty} p(y) = 1 \quad \checkmark}
$$

The Poisson distribution is a **valid probability distribution** satisfying all required properties!
:::
:::

::: {.column width="50%" .fragment}
::: {.callout-important}
## <span>üí°</span> Why This Matters

This proof guarantees that when we model financial events (defaults, claims, trades) with a Poisson distribution, all possible outcomes have probabilities that sum to 100% ‚Äî ensuring our risk calculations are mathematically sound.
:::
:::
:::


---

## üìå Example 3: Financial Trading Volume {.large}

Suppose a stock exchange sees **60 trades per hour ($\lambda = 60$)** on average. What is the probability there are **exactly 55 trades** in the next hour?

**Solution**:
$$
p(55) = \frac{60^{55}}{55!} e^{-60}
$$
Can compute using software (R, Python)

---

## üìå Example 4: Poisson Approximation to Binomial {.large}

Suppose a bank has a portfolio of **n = 1000 loans**, each with default probability **p = 0.002**, so $\lambda = np = 2$. Find $P(Y \leq 3)$ exactly using binomial and approximately using Poisson.

**Binomial**: $P(Y \leq 3) = \sum_{y=0}^{3} \binom{1000}{y} p^y (1-p)^{1000-y}$

**Poisson Approximation**:
$$
P(Y \leq 3) = \sum_{y=0}^{3} \frac{2^y}{y!} e^{-2} = p(0) + p(1) + p(2) + p(3)
$$

---

## üéÆ Interactive: Poisson vs Binomial Comparison {.smaller}

::: {style="font-size: 0.8em;"}

**Explore the Approximation:** Use the sliders to see how well the Poisson distribution approximates the Binomial when $n$ is large and $p$ is small (with $\lambda = np$ constant).

::: {.columns}

::: {.column width="30%"}

```{ojs}
//| echo: false

viewof n = Inputs.range([10, 500], {
  value: 100, 
  step: 10, 
  label: "n (number of trials):"
})

viewof p = Inputs.range([0.001, 0.1], {
  value: 0.02, 
  step: 0.001, 
  label: "p (probability of success):"
})

lambda = n * p

md`**Current Parameters:**  
n = ${n}  
p = ${p.toFixed(3)}  
Œª = np = ${lambda.toFixed(2)}`
```

**Observations:**  
When $n$ is large and $p$ is small, the distributions overlap closely.

:::

::: {.column width="70%"}

```{ojs}
//| echo: false

// Binomial probability function
function binomial_pmf(k, n, p) {
  if (k > n || k < 0) return 0;
  const logBinom = d3.sum(d3.range(1, k + 1), i => Math.log(n - i + 1) - Math.log(i));
  return Math.exp(logBinom + k * Math.log(p) + (n - k) * Math.log(1 - p));
}

// Poisson probability function
function poisson_pmf(k, lambda) {
  if (lambda <= 0) return 0;
  return Math.exp(-lambda + k * Math.log(lambda) - d3.sum(d3.range(1, k + 1), i => Math.log(i)));
}

// Generate data
max_y = Math.min(n, Math.ceil(lambda + 4 * Math.sqrt(lambda)))
data = d3.range(0, max_y + 1).map(y => ({
  y: y,
  binomial: binomial_pmf(y, n, p),
  poisson: poisson_pmf(y, lambda)
}))

Plot.plot({
  width: 800,
  height: 450,
  marginLeft: 50,
  marginBottom: 40,
  x: {
    label: "Number of Events (y) ‚Üí",
    labelOffset: 35,
    grid: true
  },
  y: {
    label: "‚Üë Probability",
    labelOffset: 40,
    domain: [0, Math.max(...data.map(d => Math.max(d.binomial, d.poisson))) * 1.1]
  },
  marks: [
    Plot.line(data, {
      x: "y", 
      y: "binomial", 
      stroke: "#2563eb",
      strokeWidth: 3,
      tip: true
    }),
    Plot.dot(data, {
      x: "y", 
      y: "binomial", 
      fill: "#2563eb",
      r: 4,
      tip: {format: {y: ".4f"}}
    }),
    Plot.line(data, {
      x: "y", 
      y: "poisson", 
      stroke: "#dc2626",
      strokeWidth: 2,
      strokeDasharray: "5,5",
      tip: true
    }),
    Plot.dot(data, {
      x: "y", 
      y: "poisson", 
      fill: "#dc2626",
      r: 3,
      tip: {format: {y: ".4f"}}
    }),
    Plot.ruleY([0])
  ],
  caption: html`<span style="color: #2563eb;">‚óè‚îÅ‚îÅ‚îÅ</span> Binomial(n, p) &nbsp;&nbsp; <span style="color: #dc2626;">‚óè‚ïå‚ïå‚ïå</span> Poisson(Œª=np)`
})
```

:::

:::

:::

---

## üéÆ Interactive: Error Analysis {.smaller}

::: {style="font-size: 0.85em;"}

**Quantifying Approximation Quality:** Compare the **absolute difference** between Binomial and Poisson probabilities.

::: {.columns}

::: {.column width="30%"}

```{ojs}
//| echo: false

viewof n2 = Inputs.range([20, 200], {
  value: 50, 
  step: 10, 
  label: "n (trials):"
})

viewof lambda2 = Inputs.range([0.5, 10], {
  value: 2, 
  step: 0.5, 
  label: "Œª (event rate):"
})

p2 = lambda2 / n2

md`**Parameters:**  
n = ${n2}  
Œª = ${lambda2}  
p = ${p2.toFixed(4)}`
```

**Financial Application:**  
In credit risk modeling with large portfolios ($n > 1000$) and low default probabilities ($p < 0.01$), the Poisson approximation maintains accuracy within 0.001 probability units!

:::

::: {.column width="70%"}

```{ojs}
//| echo: false

max_y2 = Math.min(n2, Math.ceil(lambda2 + 5 * Math.sqrt(lambda2)))

error_data = d3.range(0, max_y2 + 1).map(y => {
  const binom = binomial_pmf(y, n2, p2);
  const pois = poisson_pmf(y, lambda2);
  return {
    y: y,
    error: Math.abs(binom - pois),
    binomial: binom,
    poisson: pois
  };
})

max_error = d3.max(error_data, d => d.error)
total_error = d3.sum(error_data, d => d.error)

Plot.plot({
  width: 800,
  height: 450,
  marginLeft: 50,
  marginBottom: 40,
  x: {
    label: "Number of Events (y) ‚Üí",
    labelOffset: 35,
    grid: true
  },
  y: {
    label: "‚Üë |Binomial - Poisson|",
    labelOffset: 40
  },
  marks: [
    Plot.barY(error_data, {
      x: "y",
      y: "error",
      fill: "#f59e0b",
      tip: {format: {y: ".6f"}}
    }),
    Plot.ruleY([0])
  ],
  caption: html`Max Error: ${max_error.toFixed(6)} &nbsp;|&nbsp; Total Absolute Error: ${total_error.toFixed(4)}`
})
```

:::

:::

:::

---


## üìä Poisson Cumulative Distribution Table {.smaller}

::: {style="font-size: 0.6em;"}

**Cumulative Poisson Probabilities:** $P(Y \leq a) = \sum_{y=0}^{a} \frac{\lambda^y e^{-\lambda}}{y!}$

This table shows how cumulative probabilities increase toward 1 as we consider larger values.

$$
\begin{array}{c|ccccccccc}
\lambda \setminus a & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 \\
\hline
0.02 & 0.980 & 1.000 & & & & & & & \\
0.04 & 0.961 & 0.999 & 1.000 & & & & & & \\
0.06 & 0.942 & 0.998 & 1.000 & & & & & & \\
0.10 & 0.905 & 0.995 & 1.000 & & & & & & \\
\hline
0.20 & 0.819 & 0.982 & 0.999 & 1.000 & & & & & \\
0.30 & 0.741 & 0.963 & 0.996 & 1.000 & & & & & \\
0.40 & 0.670 & 0.938 & 0.992 & 0.999 & 1.000 & & & & \\
0.50 & 0.607 & 0.910 & 0.986 & 0.998 & 1.000 & & & & \\
\hline
0.60 & 0.549 & 0.878 & 0.977 & 0.997 & 1.000 & & & & \\
0.75 & 0.472 & 0.827 & 0.959 & 0.993 & 0.999 & 1.000 & & & \\
0.85 & 0.427 & 0.791 & 0.945 & 0.989 & 0.998 & 1.000 & & & \\
1.00 & 0.368 & 0.736 & 0.920 & 0.981 & 0.996 & 0.999 & 1.000 & & \\
\hline
1.20 & 0.301 & 0.663 & 0.879 & 0.966 & 0.992 & 0.998 & 1.000 & & \\
1.50 & 0.223 & 0.558 & 0.809 & 0.934 & 0.981 & 0.996 & 0.999 & 1.000 & \\
1.80 & 0.165 & 0.463 & 0.731 & 0.891 & 0.964 & 0.990 & 0.997 & 0.999 & 1.000 \\
2.00 & 0.135 & 0.406 & 0.677 & 0.857 & 0.947 & 0.983 & 0.995 & 0.999 & 1.000 \\
\end{array}
$$

:::

::: {.fragment}

::: {style="font-size:0.7em;"}
::: {.callout-tip}
## <span>üí°</span> Key Insight
As $\lambda$ increases, you need larger values of $a$ before $P(Y \leq a) \approx 1$. This reflects that higher event rates require considering more potential outcomes.
:::

:::

:::

---

## üéØ Key Theorem: Mean and Variance {.smaller}

::: {.callout-note}
## <span>üìù</span> Theorem 1: Mean and Variance

If $Y \sim \text{Poisson}(\lambda)$, then
$$
E(Y) = \mu = \lambda
$$
$$
Var(Y) = \sigma^2 = \lambda
$$
$$
SD(Y) = \sigma = \sqrt{\lambda}
$$
:::

---

## üìå Example 5: Modeling Rare Economic Events {.large}

Industrial losses (insurance claims) average **3 per month**. In the last 2 months, 10 claims occurred. Is this highly improbable?

Let $\lambda = 2\times3=6$. Probability $Y \geq 10$:

$$
P(Y \geq 10) = \sum_{y=10}^{\infty} \frac{6^y}{y!} e^{-6}
$$

Empirical Rule: $\mu+2\sigma = 6+2\times2.45=10.90$. Since 10 is not much above this threshold, it's not "highly" improbable but may warrant investigation.

---

## ü§î Activity: Financial Applications

::: {.activity-box}
### Brainstorm
Suggest other finance/economics scenarios where the Poisson distribution applies:

::: {.incremental}

- Call arrivals at a customer service center

- Insurance claims per day

- Defaults in a loan portfolio

- Credit card fraud events per month

- Large trades in FX market

- Blockchain transaction times
:::
:::

---

## üìù Quiz #1: Poisson Calculations {.quiz-question}

A bond analyst observes **$\lambda=1$ default per month**. What is the probability of 0 defaults?

- [0.368]{.correct data-explanation="‚úÖ Correct! P(0) = e^{-1} = 0.368"}
- 0.135
- 0.600
- 0.500

---

## üìä Using Statistical Software

Binomial and Poisson formulas can be tedious for large $n$ or $y$! Financial professionals use software:

- R: `dpois(y, lambda)`

- Python: `scipy.stats.poisson.pmf(y, lambda)`

- Excel: `=POISSON.DIST(y, lambda, FALSE)`

---

## üí∞ Case Study: Bitcoin Crash Event Modeling (Real Data) 

::: {style="font-size:35px"}

::: {.columns}
::: {.column width="50%"}
::: {.callout-note}
## <span>‚Çø</span> Investment Problem

**Crypto Portfolio Managers** need to understand and quantify risk from **sudden Bitcoin crashes** (>10% daily drops). Historical data shows crashes occur randomly but with predictable frequency patterns.

**Key Questions:**

1. How often do extreme crashes occur? (Can we model with Poisson?)

2. What's the probability of multiple crashes in a month?

3. How should risk management capital be allocated?
:::
:::

::: {.column width="50%" .fragment}
::: {.callout-tip}
## <span>üìä</span> Data Source: Real Market Data

This case study uses **REAL historical data** from:

- **Yahoo Finance API** via `yfinance` package

- **Period**: 2019-2025 (6 years of actual trading data)

- **Data Quality**: OHLCV (Open, High, Low, Close, Volume)

- **Verification**: Cross-checked against 
CoinMarketCap and CryptoDataDownload

:::
:::
:::
:::

---

## üí∞ Step 1: Download Real Bitcoin Data

::: {style="font-size:32px"}

::: {.columns}
::: {.column width="50%"}
```{r}
#| echo: true
#| message: false
#| warning: false

#Install if needed: install.packages("quantmod")
library(tidyverse)
library(lubridate)
library(quantmod)
library(knitr)
#Get data for 6 years (2019-2025)
#Download REAL Bitcoin data from Yahoo Finance
#BTC-USD is the official Bitcoin/USD trading pair
getSymbols("BTC-USD", src = "yahoo", 
           from = "2019-01-01", to = Sys.Date(),
           auto.assign = TRUE)
#Extract the data
btc_raw <- get("BTC-USD")
#Convert to data frame
btc_data <- data.frame(
  Date = index(btc_raw),
  Open = as.numeric(btc_raw[, 1]),
  High = as.numeric(btc_raw[, 2]),
  Low = as.numeric(btc_raw[, 3]),
  Close = as.numeric(btc_raw[, 4]),
  Volume = as.numeric(btc_raw[, 5]),
  Adjusted = as.numeric(btc_raw[, 6])
) %>%
  mutate(
    Daily_Return = ((Close - Open) / Open) * 100,
    Daily_Return_Adj = ((Adjusted - lag(Adjusted)) / lag(Adjusted)) * 100
  ) %>%
  filter(!is.na(Daily_Return_Adj))
#Display summary
cat("‚úì Successfully downloaded REAL Bitcoin data!")
cat("Date range:", format(min(btc_data$Date), "%Y-%m-%d"), "to", 
    format(max(btc_data$Date), "%Y-%m-%d"))
cat("Total trading days:", nrow(btc_data))

```

:::

::: {.column width="50%"}

```{r}
#Show first and last rows
cat("First 5 records:")
print(head(btc_data, 5) %>% select(Date, Open, Close, Daily_Return_Adj) %>% kable(digits = 2))

cat("Last 5 records:")
print(tail(btc_data, 5) %>% select(Date, Open, Close, Daily_Return_Adj) %>% kable(digits = 2))
```
:::
:::
:::

---

## üí∞ Step 2: Identify Crash Events in Real Data

::: {style="font-size:30px"}

::: {columns}

::: {.column width="50%"}

```{r}
#| echo: true
#| message: false

# Define crash as >10% daily drop
crash_threshold <- -10

# Identify crashes
crashes <- btc_data %>%
  filter(Daily_Return_Adj < crash_threshold) %>%
  mutate(
    Crash_Magnitude = Daily_Return_Adj,
    Crash_Type = case_when(
      Daily_Return_Adj < -30 ~ "Extreme (>30%)",
      Daily_Return_Adj < -20 ~ "Severe (20-30%)",
      Daily_Return_Adj < -15 ~ "Major (15-20%)",
      TRUE ~ "Significant (10-15%)"
    )
  )

cat("CRASH EVENT ANALYSIS")
cat(paste(rep("=", 50), collapse = ""))
cat("Total trading days:", nrow(btc_data), "\n")
cat("Crash days (>10% drop):", nrow(crashes))


```

:::

::: {.column width="50%"}

```{r}
cat("Crash frequency:", round(nrow(crashes) / nrow(btc_data) * 100, 2), "% of all days")
cat("Average crash magnitude:", round(mean(crashes$Daily_Return_Adj), 2), "%")
# Breakdown by severity
cat("Crashes by severity:\n")
print(crashes %>% 
  group_by(Crash_Type) %>%
  summarise(
    Count = n(),
    Avg_Magnitude = mean(Daily_Return_Adj),
    Min = min(Daily_Return_Adj),
    Max = max(Daily_Return_Adj),
    .groups = "drop"
  ) %>%
  kable(digits = 2))
```
:::
:::
:::

---

## üí∞ Visual: Real Bitcoin Price with Actual Crashes

```{r}
#| echo: false
#| fig-width: 14
#| fig-height: 6

ggplot(btc_data, aes(x = Date, y = Adjusted)) +
  geom_line(color = "#F7931A", linewidth = 0.8, alpha = 0.9) +
  geom_point(data = crashes, aes(x = Date, y = Adjusted, color = Crash_Type),
             size = 4, alpha = 0.8) +
  scale_color_manual(
    values = c(
      "Extreme (>30%)" = "#390ac8b3",
      "Severe (20-30%)" = "#0df128ff",
      "Major (15-20%)" = "#070707ff",
      "Significant (10-15%)" = "#ee0c0cb3"
    )
  ) +
  labs(
    title = "Real Bitcoin Price (2019-2025) with Crash Events Highlighted",
    subtitle = paste("Data source: Yahoo Finance | Total crashes (>10%): ", nrow(crashes)),
    x = "Date",
    y = "Bitcoin Price (USD)",
    color = "Crash Severity"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "top",
    panel.grid.major.y = element_line(color = "lightgray", linetype = "dotted")
  ) +
  scale_y_continuous(labels = scales::dollar) +
  scale_x_date(date_breaks = "6 months", date_labels = "%Y-%m")
```

---

## üí∞ Step 3: Monthly Crash Counts (Poisson Data)

::: {style="font-size:28px"}

::: {columns}
::: {.column width="30%"}

```{r}
#| echo: true
#| message: false

# Group real data by month and count crashes
monthly_crashes <- btc_data %>%
  mutate(YearMonth = floor_date(Date, "month")) %>%
  group_by(YearMonth) %>%
  summarise(
    Crashes_in_Month = sum(Daily_Return_Adj < -10, na.rm = TRUE),
    Trading_Days = n(),
    Avg_Return = mean(Daily_Return_Adj),
    Volatility = sd(Daily_Return_Adj),
    Min_Return = min(Daily_Return_Adj),
    Max_Return = max(Daily_Return_Adj),
    .groups = "drop"
  ) %>%
  filter(!is.na(YearMonth))

# Fit Poisson to REAL data
lambda_hat <- mean(monthly_crashes$Crashes_in_Month)
variance <- var(monthly_crashes$Crashes_in_Month)

cat("POISSON MODEL FIT (Real Data)")
cat("Mean crashes per month (Œª):", round(lambda_hat, 3), "\n")
cat("Variance of crashes:", round(variance, 3))
cat("Ratio (variance/mean):", round(variance / lambda_hat, 3))

```
:::

::: {.column width="70%"}

```{r}
#| echo: true
#| message: false

cat("Poisson goodness of fit:", 
    ifelse(abs(variance - lambda_hat) < 1, "‚úì GOOD fit", "‚úó Poor fit"))
#Display monthly summary
print(head(monthly_crashes, 10) %>% kable(digits = 2))
```
:::
:::
:::

---

## üí∞ Visual: Real Monthly Crash Distribution

```{r}
#| echo: false
#| fig-width: 12
#| fig-height: 6

# Plot observed vs Poisson fit using REAL data
observed_freq <- as.numeric(table(monthly_crashes$Crashes_in_Month))
max_crashes <- max(monthly_crashes$Crashes_in_Month)

poisson_probs <- dpois(0:max_crashes, lambda = lambda_hat) * nrow(monthly_crashes)

fit_data <- data.frame(
  Crashes = 0:max_crashes,
  Observed = c(observed_freq, rep(0, max_crashes + 1 - length(observed_freq))),
  Expected = poisson_probs
) %>% pivot_longer(cols = c(Observed, Expected), names_to = "Type")

ggplot(fit_data, aes(x = factor(Crashes), y = value, fill = Type)) +
  geom_col(position = "dodge", alpha = 0.85, width = 0.7) +
  scale_fill_manual(values = c("Observed" = "#2563eb", "Expected" = "#dc2626")) +
  labs(
    title = "Real Bitcoin Crashes per Month: Observed vs Poisson Model Fit",
    subtitle = paste("Fitted Œª =", round(lambda_hat, 2), "crashes/month | Data: 2019-2025"),
    x = "Number of Crash Events per Month",
    y = "Frequency (Number of Months)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "top",
    panel.grid.major.y = element_line(color = "lightgray", linetype = "dotted")
  )
```

---

## üí∞ Visual: Monthly Crashes Timeline (Real Data)

```{r}
#| echo: false
#| fig-cap: "Combined plot with a secondary y-axis for volatility."

# Determine a scaling factor to overlay the two series
scaling_factor <- max(monthly_crashes$Volatility, na.rm = TRUE) / max(monthly_crashes$Crashes_in_Month, na.rm = TRUE)

ggplot(monthly_crashes, aes(x = YearMonth)) +
  # Bar plot for crashes (left axis)
  geom_col(aes(y = Crashes_in_Month), fill = "#F7931A", alpha = 0.8, width = 25) +
  # Line plot for volatility (scaled to fit, right axis)
  geom_line(aes(y = Volatility / scaling_factor), color = "#2563eb", linewidth = 1.2, alpha = 0.7) +
  # Horizontal line for the Poisson mean (left axis)
  geom_hline(yintercept = lambda_hat, color = "red", linetype = "dashed", linewidth = 1.2) +
  # Annotation for the Poisson mean
  annotate("text", x = max(monthly_crashes$YearMonth) - months(6),
           y = lambda_hat + 0.3, label = paste("Œª =", round(lambda_hat, 2)),
           color = "red", fontface = "bold", size = 4) +
  # Define the primary and secondary y-axes
  scale_y_continuous(
    name = "Number of Crash Days (>10%)",
    sec.axis = sec_axis(~ . * scaling_factor, name = "Monthly Volatility (StDev %)")
  ) +
  scale_x_date(date_breaks = "6 months", date_labels = "%Y-%m") +
  labs(
    title = "Bitcoin Crash Frequency and Volatility Over Time (2019-2025)",
    subtitle = "Orange Bars: Crash Counts | Blue Line: Volatility",
    x = "Date"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title.y.left = element_text(color = "#F7931A"),
    axis.title.y.right = element_text(color = "#2563eb")
  )
```

---

## üí∞ Risk Calculations from Real Data

::: {style="font-size:30px"}
::: {columns}
::: {.column width="50%"}
```{r}
#| echo: true

# Calculate risk metrics
q50 <- qpois(0.50, lambda = lambda_hat)
q90 <- qpois(0.90, lambda = lambda_hat)
q95 <- qpois(0.95, lambda = lambda_hat)
q99 <- qpois(0.99, lambda = lambda_hat)

cat("RISK QUANTILES (Based on Real Data Fitted Model)\n")
cat(paste(rep("=", 50), collapse = ""), "\n")
cat("Median (50th percentile):", q50, "crashes\n")
cat("Normal month (90%):", q90, "or fewer crashes\n")
cat("Value at Risk 95% (VaR):", q95, "crashes/month\n")
cat("Extreme scenario 99%:", q99, "crashes/month\n\n")
```
:::

::: {.column width="50%"}

``` {r}

#| echo: true

# Probabilities
p_zero <- dpois(0, lambda = lambda_hat)
p_one <- dpois(1, lambda = lambda_hat)
p_two <- dpois(2, lambda = lambda_hat)
p_three_plus <- 1 - ppois(2, lambda = lambda_hat)

cat("KEY PROBABILITIES\n")
cat(paste(rep("=", 50), collapse = ""), "\n")
cat("P(0 crashes next month):", round(p_zero * 100, 1), "%\n")
cat("P(exactly 1 crash):", round(p_one * 100, 1), "%\n")
cat("P(exactly 2 crashes):", round(p_two * 100, 1), "%\n")
cat("P(‚â•3 crashes):", round(p_three_plus * 100, 1), "%\n")
```
:::
:::
:::


---

## üí∞ Visual: Risk Metrics Dashboard (Real Data)

```{r}
#| echo: false
#| fig-width: 12
#| fig-height: 6

# Risk dashboard based on REAL data
q50 <- qpois(0.50, lambda = lambda_hat)
q90 <- qpois(0.90, lambda = lambda_hat)
q95 <- qpois(0.95, lambda = lambda_hat)
q99 <- qpois(0.99, lambda = lambda_hat)

risk_metrics <- data.frame(
  Scenario = c("Expected\nValue", "Normal\nMonth (90%)", "Risk Level\n95%", "Extreme\n(99%)"),
  Crashes = c(lambda_hat, q90, q95, q99),
  Probability = c("Always", "90%", "95%", "99%"),
  Loss_pct = c(lambda_hat * 10, q90 * 10, q95 * 10, q99 * 10)
)

ggplot(risk_metrics, aes(x = reorder(Scenario, Crashes), y = Crashes, fill = Loss_pct)) +
  geom_col(alpha = 0.85, width = 0.6) +
  geom_text(aes(label = paste(round(Crashes, 1), "\ncrashes")),
            vjust = -0.7, size = 4.5, fontface = "bold") +
  scale_fill_gradient(low = "#2563eb", high = "#dc2626", name = "Expected\nLoss %") +
  labs(
    title = "Real Bitcoin Risk Dashboard (Based on 2019-2025 Data)",
    subtitle = "Poisson model fitted to actual crash frequencies",
    x = "Risk Scenario",
    y = "Expected Number of Crashes per Month"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.y = element_line(color = "lightgray", linetype = "dotted"),
    legend.position = "right"
  ) +
  ylim(0, max(risk_metrics$Crashes) * 1.25)
```

---

## üí∞ Business Recommendations (Real Data)

::: {.columns}
::: {.column width="50%"}
::: {.callout-note}
## <span>üìä</span> Key Findings from Real Data

- **Average monthly crashes**: Œª = `r round(lambda_hat, 2)` extreme events
- **Data period**: 2019-2025 (6 years of actual trading)
- **Total crashes observed**: `r nrow(crashes)` days with >10% drops
- **Model validation**: Poisson fits real data reasonably well
- **Normal month**: Expect ‚â§ `r qpois(0.90, lambda_hat)` crashes
- **95% Risk**: Up to `r qpois(0.95, lambda_hat)` crashes
- **Extreme case**: Up to `r qpois(0.99, lambda_hat)` crashes
:::
:::

::: {.column width="50%" .fragment}
::: {.callout-important}
## <span>üíº</span> Portfolio Risk Actions

1. **Hedging**: Protect against `r qpois(0.95, lambda_hat)` monthly crashes
2. **Liquidity**: Hold 15-20% stablecoin reserves
3. **Position Limits**: Max 50% BTC if monthly VaR > 20%
4. **Monitoring**: Track actual vs predicted monthly crashes
5. **Rebalance**: Quarterly reviews using updated data
6. **Stop-Loss**: Exit if 3+ crashes in 2 weeks or >15% monthly loss
:::
:::
:::

---

## üí∞ Data Verification & Sources

::: {.callout-tip}
## <span>‚úì</span> Real Data Confirmation

This analysis uses **VERIFIED REAL DATA**:

‚úÖ **Source**: Yahoo Finance API (yfinance package)  
‚úÖ **Ticker**: BTC-USD (Bitcoin/USD official pair)  
‚úÖ **Period**: 2019-01-01 to latest available date  
‚úÖ **Quality**: OHLCV data (Open, High, Low, Close, Volume)  
‚úÖ **Cross-check**: Matches CoinMarketCap and CryptoDataDownload historical prices  

:::

::: {.callout-note}
## <span>üîß</span> Reproduce This Analysis

```{r}
#| echo: true
#| eval: false

# Run this code to get the SAME real data
library(quantmod)
library(tidyverse)

# Download real data
getSymbols("BTC-USD", src = "yahoo",
           from = "2019-01-01", to = Sys.Date(),
           auto.assign = TRUE)

# Your data is now in the 'BTC-USD' object
head(BTC.USD)  # Check first 6 rows

# This is the EXACT same real data used in this case study!
```

:::

---

## üí∞ Alternative Real Data Sources

::: {.callout-tip}
## <span>üì•</span> Other Verified Real Data Options

**Option 1: CryptoDataDownload (Free, Daily Data)**
- Website: https://www.cryptodatadownload.com/
- Format: CSV downloads
- Coverage: Daily OHLCV data
- Updated: Daily

**Option 2: Kaggle Datasets (Free)**
- Search: "Bitcoin Historical Data"
- BITCOIN Historical Datasets 2018-2025 Binance API
- Bitcoin Daily Price (2017-2023)
- Download as CSV

**Option 3: CoinGecko API (Free, No Auth)**
- Website: https://www.coingecko.com/en/api
- Format: JSON API responses
- Coverage: Historical, current, market data
- Rate limit: Generous free tier

<span>**Option 4: Python Code (Using yfinance)**
</span> 
```python
import yfinance as yf
import pandas as pd

# Download real data
btc = yf.download("BTC-USD", start="2019-01-01", end="2025-01-01")
btc.to_csv("bitcoin_real_data.csv")
print(btc.head())
```

:::

---

## üìù Summary

::: {.summary-box}
<span>‚úÖ</span> Key Takeaways

- **Poisson models event frequencies** in fixed intervals

- Mean and variance both $=\lambda$

- Excellent for default risk, insurance, arrivals, rare event modeling

- Approximates binomial well for large $n$, small $p$
:::

--- 

## üìö Practice Problems 

::: {.callout-tip}
## <span>üìù</span> Homework Problems
1. **Loan Portfolio Default Modeling**: If $\lambda=4$ defaults/month, find $P(\text{exactly 2 defaults})$ and $P(D \geq 3)$

2. **Insurance Claim Risk**: For $\lambda=8$ claims/month, what's probability of 6 or fewer? Is 12 claims unusually high?

3. **Call Center Analysis**: If $\lambda=25$ calls/hour, probability of $C\leq20$ calls?

4. **Trading Outliers**: Stock returns see ‚Äúlarge moves (L)‚Äù ($>2\sigma$) $\lambda=1$/week. In 10 weeks, find $P(L\geq3)$.
:::

---

## üëã Thank You! {.smaller .center}
::: {.columns}
::: {.column width="50%"}
**üì¨ Contact Information:**

**Samir Orujov**  
Assistant Professor  
School of Business
ADA University

üìß **Email**: [sorujov@ada.edu.az](mailto:sorujov@ada.edu.az)  
üè¢ **Office**: D312
‚è∞ **Office Hours**: By appointment
:::

::: {.column width="50%"}
**üìÖ Next Class:**

- **Topic**: Continuous Random Variables

- **Reading**: Chapter 3.7

- **Preparation**: Review Poisson examples

**‚è∞ Reminders:**

- ‚úÖ Complete all homework problems

- ‚úÖ Practice with Poisson software

- ‚úÖ Work hard
:::
:::

## ‚ùì Questions? {.center}
::: {.callout-note}
## <span>üí¨</span> Open Discussion (5 minutes)

- Applications to your research or work

- Computational tips and tricks

- Parameter estimation

- Modeling rare risk events in portfolios
:::
