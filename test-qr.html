<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QR Code Test</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
        #qr-container { margin: 20px auto; padding: 10px; border: 3px solid #667eea; border-radius: 10px; display: inline-block; background: white; }
        #qr-status { color: #667eea; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>QR Code Test - Nayuki Library</h1>
    
    <div id="qr-container"></div>
    <p id="qr-status">Loading...</p>
    
    <button onclick="testQR()">Generate Test QR</button>
    
    <script src="assets/js/vendor/qrcodegen.js"></script>
    <script>
        var qrContainer = document.getElementById('qr-container');
        var statusEl = document.getElementById('qr-status');
        
        function waitForLib(callback) {
            console.log('Checking for qrcodegen...', typeof qrcodegen);
            if (typeof qrcodegen !== 'undefined') {
                console.log('qrcodegen found!', qrcodegen);
                callback();
            } else {
                console.log('qrcodegen not found, retrying...');
                setTimeout(function() { waitForLib(callback); }, 100);
            }
        }
        
        function drawQR(text) {
            try {
                console.log('Attempting to create QR with qrcodegen:', qrcodegen);
                console.log('QrCode available:', qrcodegen.QrCode);
                console.log('Ecc available:', qrcodegen.QrCode.Ecc);
                
                // Create QR Code using Nayuki's qrcodegen library
                var qr = qrcodegen.QrCode.encodeText(text, qrcodegen.QrCode.Ecc.HIGH);
                console.log('QR created successfully, size:', qr.size);
                
                // Render as SVG
                var cellSize = 8;
                var border = 4;
                var size = qr.size;
                var totalSize = (size + border * 2) * cellSize;
                
                var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', totalSize);
                svg.setAttribute('height', totalSize);
                svg.setAttribute('viewBox', '0 0 ' + totalSize + ' ' + totalSize);
                
                // White background
                var bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bg.setAttribute('width', totalSize);
                bg.setAttribute('height', totalSize);
                bg.setAttribute('fill', '#ffffff');
                svg.appendChild(bg);
                
                // Draw QR modules
                for (var y = 0; y < size; y++) {
                    for (var x = 0; x < size; x++) {
                        if (qr.getModule(x, y)) {
                            var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                            rect.setAttribute('x', ((x + border) * cellSize).toString());
                            rect.setAttribute('y', ((y + border) * cellSize).toString());
                            rect.setAttribute('width', cellSize.toString());
                            rect.setAttribute('height', cellSize.toString());
                            rect.setAttribute('fill', '#000000');
                            svg.appendChild(rect);
                        }
                    }
                }
                
                qrContainer.innerHTML = '';
                qrContainer.appendChild(svg);
                
                statusEl.textContent = '✓ QR Generated Successfully!';
                statusEl.style.color = '#28a745';
                return true;
                
            } catch (e) {
                console.error('QR generation error:', e);
                statusEl.textContent = '⚠ Error: ' + e.message;
                statusEl.style.color = '#dc3545';
                return false;
            }
        }
        
        function testQR() {
            var testUrl = 'https://sorujov.github.io/attend/math-stat-1/?tok=' + btoa(Date.now() + '-STAT2311-F25');
            console.log('Testing QR generation for:', testUrl);
            drawQR(testUrl);
        }
        
        // Wait for library, then generate initial QR
        waitForLib(function() {
            console.log('Nayuki QR library loaded successfully');
            statusEl.textContent = 'Library loaded! Click button to test.';
            statusEl.style.color = '#28a745';
        });
    </script>
</body>
</html>